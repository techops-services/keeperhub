name: PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize]
    branches:
      - staging

jobs:
  check-title:
    runs-on: ubuntu-latest

    steps:
      - name: Validate PR title follows conventional commit format
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Allowed prefixes (must match release.yml classification)
          PATTERN="^(feat|fix|bug|hotfix|breaking|chore|docs|refactor|test|ci|build|perf|style)(\([^)]*\))?[!]?:[[:space:]].+"

          if printf '%s' "$PR_TITLE" | grep -qiE "$PATTERN"; then
            echo "PR title is valid: $PR_TITLE"
          else
            echo "----------------------------------------------"
            echo "  ERROR: PR title does not follow the required format"
            echo "----------------------------------------------"
            echo ""
            echo "  Got: $PR_TITLE"
            echo ""
            echo "  Expected format:"
            echo "    <type>: <description>"
            echo "    <type>(scope): <description>"
            echo ""
            echo "  Allowed types:"
            echo "    feat:      New feature"
            echo "    fix:       Bug fix"
            echo "    hotfix:    Urgent bug fix"
            echo "    chore:     Maintenance task"
            echo "    docs:      Documentation"
            echo "    refactor:  Code refactoring"
            echo "    test:      Tests"
            echo "    ci:        CI/CD changes"
            echo "    build:     Build system"
            echo "    perf:      Performance"
            echo "    style:     Code style"
            echo "    breaking:  Breaking change"
            echo ""
            echo "  Examples:"
            echo "    feat: KEEP-1234 Add user authentication"
            echo "    fix(web3): KEEP-1234 Resolve wallet connection timeout"
            echo "    chore: Update dependencies"
            echo ""
            exit 1
          fi
