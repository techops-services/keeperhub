# Project State

## Project Reference

See: .planning/PROJECT.md (updated 2026-02-20)

**Core value:** Users can build and deploy Web3 automation workflows through a visual builder without writing code
**Current focus:** v1.3 Direct Execution API

## Current Position

Milestone: v1.3 Direct Execution API
Phase: Not started (defining requirements)
Plan: --
Status: Defining requirements
Last activity: 2026-02-20 -- Milestone v1.3 started

Progress: [░░░░░░░░░░] 0% (v1.3)

## Performance Metrics

**Velocity:**
- Total plans completed: 23 (v1.0: 12, v1.1: 2, v1.2: 9)
- Average duration: 4 min
- v1.0 total: ~40 min
- v1.1 total: ~10 min
- v1.2 total: ~38 min (10 plans)

## Accumulated Context

### Decisions

- outputFileTracingIncludes for @vercel/og: forces dynamically-imported WASM into standalone
- Phase 6 dropped from v1.1: meta tags/social validation deferred
- File-based protocol definitions (no DB for MVP)
- Reuse existing read/write-contract core via -core.ts extraction
- Generic protocol icon for MVP -- custom icons per-protocol deferred to future
- Core logic files (read-contract-core.ts, write-contract-core.ts) have no "use step" -- only way to share step logic across multiple step files without breaking workflow bundler
- _context type inlined in core input types (no StepInput import) -- step-handler is step-only infrastructure
- defineProtocol() is an identity function (returns def unchanged) -- TypeScript enforces shape at compile time, runtime validates correctness
- Module-level KEBAB_CASE_REGEX and HEX_ADDRESS_REGEX constants used to satisfy Biome useTopLevelRegex rule
- protocolToPlugin imports ProtocolIcon directly (no icon parameter) -- single canonical icon for all protocol plugins at MVP
- Plugin shell index.ts does not call registerIntegration() -- registration handled by discover-plugins (Plan 03)
- _protocolMeta field uses type=text with JSON defaultValue -- UI hides underscore-prefixed fields automatically
- buildFunctionArgs extracted as non-exported module-level function per step file -- cannot be shared due to "use step" bundler constraints; intentional duplication
- protocol-write passes _context.triggerType to writeContractCore for gas strategy (manual vs automated trigger pricing)
- registeredProtocolSlugs module-level variable in discover-plugins for cross-function communication (populated by registerProtocolPlugins, consumed by generateStepRegistry and processStepFilesForCodegen)
- generateTypesFile() called once after registerProtocolPlugins() in main() -- ordering required for correct IntegrationType union generation
- Protocol steps skipped in processStepFilesForCodegen() -- no stepHandler function, delegate to shared core files
- keeperhub/protocols/index.ts barrel generated by discover-plugins -- imports all protocol definitions and registers them at import time
- Protocol plugin shell imports @/keeperhub/protocols as side-effect -- triggers registration at server startup via plugin import chain
- slugToVarName() converts protocol slugs to valid JS variable names (e.g., "aave-v3" → "aaveV3Def")
- registeredProtocolEntries module-level variable stores protocol metadata for barrel generation
- fetchAbiFromExplorer extracted as non-exported module-level function to keep resolveAbi cognitive complexity under 15
- ABI cache key format: chainId:lowercaseAddress for deterministic lookups
- resolveAbi uses shared lib/explorer modules directly, does not call fetch-abi API route
- Protocol address keys use numeric chain ID strings (e.g., "1", "8453") matching chain-select stored values
- Omitted Polygon from WETH -- that address is WMATIC, semantically different
- chain-utils.ts is client-safe (no server imports) -- maps numeric chain ID strings to human-readable names
- Protocol API endpoint is synchronous (no async) -- registry is populated at import time via side-effect import
- _selectedProtocol underscore prefix for unused destructured state -- Plan 02 will consume it
- Tab switcher uses underline variant via className overrides on shadcn Tabs components
- Protocol search is a standalone inline input (not reusing WorkflowSearchFilter) to avoid over-complicating the existing component
- selectedProtocolDef derived variable for safe protocol lookup (avoids crash if slug not found)
- ProtocolDetail uses useRouter for "Use in Workflow" navigation to "/" (pre-adding node deferred)
- ActionTypeBadge and ActionChainBadges kept as non-exported module-level components in protocol-detail.tsx
- Per-action chain badges show only chains where that action's contract is deployed (not all protocol chains)
- Protocol step files import @/keeperhub/protocols as side-effect -- step files are dynamically imported at runtime independent of server startup plugin chain, so registry must be populated within the step file's own import graph

### Pending Todos

- [ ] Merge PR #195 (monorepo cleanup) after stability verification
- [ ] Run git-filter-repo after PR merge
- [ ] Fix workflow OG node icons and names not rendering (PR #326 open)
- [ ] Meta tags & social platform validation (deferred from v1.1 Phase 6)

### Blockers/Concerns

None

### Quick Tasks Completed

| # | Description | Date | Commit | Directory |
|---|-------------|------|--------|-----------|
| 1 | adjust the hub ui from F-048 on pr 380 | 2026-02-20 | 520f00c | [1-adjust-the-hub-ui-from-f-048-on-pr-380](./quick/1-adjust-the-hub-ui-from-f-048-on-pr-380/) |
| 2 | protocol detail routes with OG image gen | 2026-02-20 | c8818db | [2-protocol-detail-routes-with-og-image-gen](./quick/2-protocol-detail-routes-with-og-image-gen/) |
| 4 | fix unknown protocol weth error in workflow execution | 2026-02-20 | a292c8563 | [4-fix-unknown-protocol-weth-error-in-workf](./quick/4-fix-unknown-protocol-weth-error-in-workf/) |

## Session Continuity

Last session: 2026-02-20
Stopped at: Completed quick task 4 (fix unknown protocol weth error)
Resume file: None

**Next action:** Define requirements and create roadmap for v1.3
