---
phase: 07-plugin-auto-generation
plan: "04"
type: execute
wave: 1
depends_on: ["07-01", "07-02", "07-03"]
files_modified:
  - scripts/discover-plugins.ts
  - keeperhub/protocols/index.ts
  - keeperhub/plugins/protocol/index.ts
autonomous: true
gap_closure: true
requirements: [PLUG-02, PLUG-03, STEP-01, STEP-02, STEP-03, STEP-04]

must_haves:
  truths:
    - "Protocol definitions are imported at Next.js server startup, populating the protocolRegistry Map before any step execution"
    - "Protocol plugins are registered in the plugin registry at server startup, making them visible to getAllIntegrations()"
    - "The MCP schemas endpoint (/api/mcp/schemas) includes protocol actions in its response"
    - "protocolReadStep and protocolWriteStep resolve protocols successfully at runtime (getProtocol returns a definition, not undefined)"
  artifacts:
    - path: "keeperhub/protocols/index.ts"
      provides: "Auto-generated barrel file that imports all protocol definitions and registers them at import time"
      contains: "registerProtocol"
    - path: "keeperhub/plugins/protocol/index.ts"
      provides: "Protocol plugin shell that now imports the protocols barrel"
      contains: "keeperhub/protocols"
    - path: "scripts/discover-plugins.ts"
      provides: "New generateProtocolsIndexFile function that creates the barrel"
      contains: "generateProtocolsIndexFile"
  key_links:
    - from: "keeperhub/plugins/protocol/index.ts"
      to: "keeperhub/protocols/index.ts"
      via: "import side-effect"
      pattern: 'import "@/keeperhub/protocols"'
    - from: "keeperhub/protocols/index.ts"
      to: "keeperhub/lib/protocol-registry.ts"
      via: "import registerProtocol and protocolToPlugin"
      pattern: "registerProtocol"
    - from: "keeperhub/protocols/index.ts"
      to: "plugins/registry.ts"
      via: "import registerIntegration"
      pattern: "registerIntegration"
    - from: "plugins/index.ts"
      to: "keeperhub/plugins/index.ts"
      via: "import side-effect chain"
      pattern: '@/keeperhub/plugins'
    - from: "keeperhub/plugins/index.ts"
      to: "keeperhub/plugins/protocol/index.ts"
      via: "import side-effect (protocol is a discovered plugin directory)"
      pattern: './protocol'
---

<objective>
Fix the critical runtime gap: protocol definitions are not loaded at Next.js server startup, causing getProtocol() to return undefined and protocol actions to be invisible to the MCP schemas endpoint.

Purpose: Without this fix, all protocol step execution fails at runtime ("Unknown protocol: <slug>") and the MCP schemas endpoint omits protocol actions entirely. This is the last gap preventing Phase 7's success criteria from being met.

Output: A generated `keeperhub/protocols/index.ts` barrel file (created by discover-plugins) that imports every protocol definition and registers it in both the protocol registry and plugin registry at import time. This barrel is imported by the protocol plugin shell, which is itself imported at server startup through the existing plugin import chain.
</objective>

<execution_context>
@/Users/skp/.claude/get-shit-done/workflows/execute-plan.md
@/Users/skp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-plugin-auto-generation/07-01-SUMMARY.md
@.planning/phases/07-plugin-auto-generation/07-02-SUMMARY.md
@.planning/phases/07-plugin-auto-generation/07-03-SUMMARY.md
@.planning/phases/07-plugin-auto-generation/07-VERIFICATION.md

@scripts/discover-plugins.ts
@keeperhub/lib/protocol-registry.ts
@keeperhub/plugins/protocol/index.ts
@keeperhub/protocols/test-weth.ts
@plugins/index.ts
@keeperhub/plugins/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add generateProtocolsIndexFile() to discover-plugins and wire into main()</name>
  <files>scripts/discover-plugins.ts</files>
  <action>
Add a new function `generateProtocolsIndexFile()` to `scripts/discover-plugins.ts` that generates `keeperhub/protocols/index.ts`. This file is the server-side bootstrap mechanism -- when imported, it registers all protocol definitions in both the protocol registry and the plugin registry.

**The generated barrel file pattern:**

The generated `keeperhub/protocols/index.ts` should look like this (for a single WETH protocol):

```typescript
/**
 * Protocol Definitions Index (Auto-Generated)
 *
 * This file is automatically generated by scripts/discover-plugins.ts
 * DO NOT EDIT MANUALLY - your changes will be overwritten!
 *
 * Imports all protocol definitions and registers them at import time.
 * This ensures the protocol registry is populated when the Next.js
 * server starts (via the plugin import chain).
 *
 * Registered protocols: weth
 */

import {
  protocolToPlugin,
  registerProtocol,
} from "@/keeperhub/lib/protocol-registry";
import { registerIntegration } from "@/plugins/registry";

import wethDef from "./weth";

registerProtocol(wethDef);
registerIntegration(protocolToPlugin(wethDef));
```

For multiple protocols, add additional import + register pairs. The variable name should be derived from the protocol slug by converting kebab-case to camelCase + "Def" suffix (e.g., slug "aave-v3" becomes `aaveV3Def`).

**Implementation of `generateProtocolsIndexFile()`:**

1. Takes no parameters -- reads from `registeredProtocolSlugs` module-level variable (populated by `registerProtocolPlugins()` which runs before this in main())
2. Also needs the file stems (filenames without .ts extension) mapped to slugs. Get this by calling `discoverProtocols()` and extracting stems from file paths, then matching them with the loaded protocol definitions.
3. Actually, simplify: change `loadProtocolDefinitions()` to also return the file stem (the filename without .ts extension) alongside the slug and definition. Update the `ProtocolEntry` type:
   ```typescript
   type ProtocolEntry = {
     slug: string;
     fileStem: string;
     definition: import("../keeperhub/lib/protocol-registry").ProtocolDefinition;
   };
   ```
   In `loadProtocolDefinitions()`, compute `fileStem` from the file path: `basename(filePath, ".ts")`.
4. Store loaded protocol entries in a module-level variable alongside `registeredProtocolSlugs` so `generateProtocolsIndexFile()` can access file stems:
   ```typescript
   let registeredProtocolEntries: ProtocolEntry[] = [];
   ```
   Populate this in `registerProtocolPlugins()` after loading definitions.
5. In `generateProtocolsIndexFile()`:
   - If `registeredProtocolEntries` is empty, generate a minimal file with just a comment and no imports
   - Convert each slug to a valid JS variable name: replace hyphens with camelCase, append "Def" (e.g., "weth" -> "wethDef", "aave-v3" -> "aaveV3Def")
   - Generate import statements: `import {varName} from "./{fileStem}";`
   - Generate registration calls: `registerProtocol({varName});` and `registerIntegration(protocolToPlugin({varName}));`
   - Write to `keeperhub/protocols/index.ts`
6. Import `basename` from `node:path` at the top of the file (it's already imported via `join` and `dirname`)

**Wire into main():**

Add a call to `generateProtocolsIndexFile()` in `main()` immediately after `registerProtocolPlugins()`:

```typescript
console.log("Registering protocol plugins...");
const protocolSlugs = await registerProtocolPlugins();
console.log(`Registered ${protocolSlugs.length} protocol(s)`);

console.log("Generating keeperhub/protocols/index.ts...");
generateProtocolsIndexFile();
```

**Helper function for slug-to-variable-name conversion:**

```typescript
function slugToVarName(slug: string): string {
  return slug.replace(/-([a-z0-9])/g, (_, char: string) => char.toUpperCase()) + "Def";
}
```

IMPORTANT: Use `for...of` loops, not `.forEach()`. Use `const` by default. Keep cognitive complexity under 15 per function. Use block statements for if/else.
  </action>
  <verify>
1. `pnpm type-check` -- zero new errors
2. `pnpm check` -- zero new lint errors
3. `pnpm discover-plugins` -- completes without errors. If `keeperhub/protocols/test-weth.ts` exists, verify that `keeperhub/protocols/index.ts` is generated with correct import and registration for `weth`.
4. If no protocol files exist, verify that `keeperhub/protocols/index.ts` is generated with a minimal "no protocols" comment.
  </verify>
  <done>
`generateProtocolsIndexFile()` exists in discover-plugins.ts and generates `keeperhub/protocols/index.ts`.
The generated file imports all protocol definitions and calls registerProtocol() + registerIntegration(protocolToPlugin()) for each.
The function is wired into main() after registerProtocolPlugins().
  </done>
</task>

<task type="auto">
  <name>Task 2: Update protocol plugin shell to import the protocols barrel at server startup</name>
  <files>keeperhub/plugins/protocol/index.ts</files>
  <action>
Update `keeperhub/plugins/protocol/index.ts` to import the generated protocols barrel file. This is the critical wiring that connects protocol definitions to the server startup import chain.

**Current file:**
```typescript
/**
 * Protocol Plugin Shell
 * ...
 */
export { ProtocolIcon } from "./icon";
```

**Updated file:**
```typescript
/**
 * Protocol Plugin Shell
 *
 * Protocol integrations are dynamically generated from protocol definitions
 * in keeperhub/protocols/. Each protocol becomes its own IntegrationPlugin
 * via protocolToPlugin() in keeperhub/lib/protocol-registry.ts.
 *
 * The import below triggers protocol registration at server startup:
 * keeperhub/protocols/index.ts is auto-generated by discover-plugins and
 * calls registerProtocol() + registerIntegration() for each protocol definition.
 */

// Register all protocol definitions at import time (auto-generated barrel)
import "@/keeperhub/protocols";

export { ProtocolIcon } from "./icon";
```

**Why this works (the import chain):**

1. Next.js server starts, loads route handlers
2. Any server-side route imports `@/plugins` (e.g., the MCP schemas endpoint imports `@/plugins`)
3. `plugins/index.ts` imports `@/keeperhub/plugins` (line in generated file)
4. `keeperhub/plugins/index.ts` imports `./protocol` (generated by discover-plugins, since `protocol` is a discovered plugin directory)
5. `keeperhub/plugins/protocol/index.ts` imports `@/keeperhub/protocols` (THIS CHANGE)
6. `keeperhub/protocols/index.ts` imports each protocol file and calls `registerProtocol()` + `registerIntegration(protocolToPlugin())`
7. Both the protocol registry Map AND the plugin registry are now populated at server startup

After this change, `getProtocol("weth")` returns the WETH definition at runtime, and `getAllIntegrations()` includes the WETH plugin.

**Verification:** After making this change, run `pnpm discover-plugins` to ensure the protocol plugin shell is still correctly discovered (it should be -- the import is a side-effect import, not a new export). Then run `pnpm type-check` and `pnpm check`.

IMPORTANT: The `protocol` plugin directory must appear in the allowlist (or the allowlist must be absent). Check `config/plugin-allowlist.json` -- if it exists and `protocol` is not listed, add it. If the file does not exist, no action needed (all plugins enabled by default).
  </action>
  <verify>
1. `pnpm type-check` -- zero errors
2. `pnpm check` -- zero lint errors
3. `pnpm discover-plugins` -- completes without errors
4. `keeperhub/plugins/protocol/index.ts` contains `import "@/keeperhub/protocols";`
5. If `config/plugin-allowlist.json` exists, verify `protocol` is included
  </verify>
  <done>
`keeperhub/plugins/protocol/index.ts` imports `@/keeperhub/protocols` as a side-effect.
This connects the server startup import chain to protocol definitions.
Protocol definitions will be registered in both registries when the Next.js server imports its plugin tree.
  </done>
</task>

</tasks>

<verification>
1. `pnpm discover-plugins` runs successfully and generates `keeperhub/protocols/index.ts`
2. `pnpm type-check` passes with zero errors
3. `pnpm check` passes with zero lint errors
4. With a protocol definition file (e.g., `keeperhub/protocols/test-weth.ts`), the generated barrel file imports it and registers both in the protocol registry and plugin registry
5. The import chain is complete: `plugins/index.ts` -> `keeperhub/plugins/index.ts` -> `keeperhub/plugins/protocol/index.ts` -> `keeperhub/protocols/index.ts` -> protocol definition files
6. At server runtime, `getProtocol("weth")` returns the WETH ProtocolDefinition (not undefined)
7. At server runtime, `getAllIntegrations()` includes the WETH IntegrationPlugin
8. The MCP schemas endpoint includes protocol actions in its response
</verification>

<success_criteria>
- Protocol definitions are registered at Next.js server startup through the plugin import chain
- getProtocol() returns valid definitions at runtime (the protocolRegistry Map is populated)
- getAllIntegrations() includes protocol plugins at runtime
- The /api/mcp/schemas endpoint includes protocol actions
- No manual intervention needed beyond running pnpm discover-plugins after adding a protocol file
</success_criteria>

<output>
After completion, create `.planning/phases/07-plugin-auto-generation/07-04-SUMMARY.md`
</output>
