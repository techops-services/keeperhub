# =============================================================================
# KeeperHub Docker Compose
#
# Profiles:
#   dev              - Full development stack (no K8s Jobs, dispatcher runs as cron)
#   minikube         - Hybrid mode (services in Docker, job-spawner in Minikube)
#   prod             - Production-ready containers
#   profile-workflows - Workflow profiling tools (js-sandbox for WASM fuel calibration)
#
# Usage:
#   docker compose --profile dev up -d              # Development (no K8s)
#   docker compose --profile minikube up -d         # Hybrid mode
#   docker compose --profile profile-workflows up -d # Profiling tools
#   make hybrid-setup                               # Full hybrid setup
# =============================================================================

# -----------------------------------------------------------------------------
# Primitives (from .env or defaults)
# -----------------------------------------------------------------------------
x-primitives:
  db_name: &db_name "${POSTGRES_DB:-keeperhub}"
  db_user: &db_user "${POSTGRES_USER:-postgres}"
  db_password: &db_password "${POSTGRES_PASSWORD:-postgres}"
  aws_region: &aws_region "us-east-1"
  aws_access_key: &aws_access_key "test"
  aws_secret_key: &aws_secret_key "test"

# -----------------------------------------------------------------------------
# Environment Groups
# -----------------------------------------------------------------------------
x-env-db: &env_db
  POSTGRES_USER: *db_user
  POSTGRES_PASSWORD: *db_password
  POSTGRES_DB: *db_name

x-env-db-connection: &env_db_connection
  DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-keeperhub}

x-env-aws: &env_aws
  AWS_REGION: *aws_region
  AWS_ACCESS_KEY_ID: *aws_access_key
  AWS_SECRET_ACCESS_KEY: *aws_secret_key
  # Use host.minikube.internal so URLs work from both host and Minikube
  AWS_ENDPOINT_URL: http://host.minikube.internal:4566

x-env-sqs: &env_sqs
  SQS_QUEUE_URL: http://host.minikube.internal:4566/000000000000/keeperhub-workflow-queue

x-env-service-keys: &env_service_keys
  SCHEDULER_SERVICE_API_KEY: local-scheduler-key-for-dev
  MCP_SERVICE_API_KEY: local-mcp-key-for-dev
  EVENTS_SERVICE_API_KEY: local-events-key-for-dev

# -----------------------------------------------------------------------------
# Services
# -----------------------------------------------------------------------------
services:
  # ===========================================================================
  # Database
  # ===========================================================================
  db:
    image: postgres:16-alpine
    container_name: keeperhub-db
    hostname: db
    restart: unless-stopped
    environment:
      <<: *env_db
    ports:
      - "5433:5432" # External 5433 to avoid host port conflicts, internal 5432
    volumes:
      - keeperhub_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5
    profiles:
      - dev
      - minikube
      - prod
      - profile-workflows

  # ===========================================================================
  # LocalStack (SQS)
  # ===========================================================================
  localstack:
    image: localstack/localstack:latest
    container_name: keeperhub-localstack
    hostname: localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=sqs
      - DEBUG=0
      - SQS_ENDPOINT_STRATEGY=path
      # Use host.minikube.internal so queue URLs work from both host and Minikube
      - LOCALSTACK_HOST=host.minikube.internal:4566
    volumes:
      - ./deploy/local/hybrid/init-localstack.sh:/etc/localstack/init/ready.d/init-aws.sh:ro
      - keeperhub_localstack_data:/var/lib/localstack
    healthcheck:
      test: ["CMD-SHELL", "awslocal sqs list-queues || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    profiles:
      - dev
      - minikube

  # ===========================================================================
  # KeeperHub App (Next.js)
  # ===========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    image: keeperhub:latest
    container_name: keeperhub-app
    hostname: keeperhub
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      <<: [*env_db_connection, *env_aws, *env_sqs]
      NODE_ENV: production
      KEEPERHUB_API_KEY: ${KEEPERHUB_API_KEY:-}
    depends_on:
      db:
        condition: service_healthy
    profiles:
      - prod

  # Development app with hot reload
  app-dev:
    image: node:22-alpine
    container_name: keeperhub-app-dev
    hostname: keeperhub
    working_dir: /app
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - keeperhub_node_modules:/app/node_modules
    env_file:
      - .env
    environment:
      <<: [*env_db_connection, *env_aws, *env_sqs, *env_service_keys]
      HOSTNAME: "0.0.0.0"
      KEEPERHUB_API_KEY: ${KEEPERHUB_API_KEY:-some-random-api-key}
      NODE_OPTIONS: "--max-old-space-size=3072"
      METRICS_COLLECTOR: prometheus
    deploy:
      resources:
        limits:
          memory: 4g
          cpus: "2.0"
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
    command: sh -c "npm install -g pnpm && CI=true pnpm install && pnpm dev --hostname 0.0.0.0"
    profiles:
      - dev
      - minikube

  # ===========================================================================
  # Schedule Dispatcher (keeperhub-scheduler submodule)
  # Runs every minute to check for due schedules and send messages to SQS
  # ===========================================================================
  dispatcher:
    build:
      context: ./keeperhub-scheduler
      dockerfile: Dockerfile
      target: dispatcher
    image: keeperhub-dispatcher:latest
    container_name: keeperhub-dispatcher
    restart: unless-stopped
    working_dir: /app
    environment:
      <<: *env_db_connection
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_ENDPOINT_URL: http://localstack:4566
      SQS_QUEUE_URL: http://localstack:4566/000000000000/keeperhub-workflow-queue
      KEEPERHUB_URL: http://app-dev:3000
      KEEPERHUB_API_KEY: ${KEEPERHUB_API_KEY:-local-scheduler-key-for-dev}
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
      app-dev:
        condition: service_started
    # Run dispatcher every minute using a simple loop
    # (Docker doesn't have native cron, so we simulate it)
    command: |
      sh -c 'while true; do
        echo "[Dispatcher] Running at $$(date)"
        tsx scripts/scheduler/schedule-dispatcher.ts
        echo "[Dispatcher] Sleeping 60s..."
        sleep 60
      done'
    profiles:
      - dev # Only in dev profile (not minikube - uses K8s CronJob)

  # ===========================================================================
  # Schedule Executor (Direct execution for dev profile)
  # Polls SQS and executes workflows directly (no K8s Jobs)
  # NOTE: In minikube profile, job-spawner runs in K8s instead
  # ===========================================================================
  executor:
    build:
      context: .
      dockerfile: Dockerfile
      target: scheduler
    image: keeperhub-scheduler:latest
    container_name: keeperhub-executor
    restart: unless-stopped
    working_dir: /app
    environment:
      <<: *env_db_connection
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_ENDPOINT_URL: http://localstack:4566
      SQS_QUEUE_URL: http://localstack:4566/000000000000/keeperhub-workflow-queue
      KEEPERHUB_URL: http://app-dev:3000
      KEEPERHUB_API_KEY: ${KEEPERHUB_API_KEY:-local-scheduler-key-for-dev}
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
      app-dev:
        condition: service_started
    command: >
      sh -c 'while true; do
        echo "[Dispatcher] Running at $$(date)";
        tsx schedule-dispatcher/index.ts;
        echo "[Dispatcher] Sleeping 60s...";
        sleep 60;
      done'
    profiles:
      - dev
      - minikube

  # ===========================================================================
  # Event Worker (keeperhub-events submodule)
  # Fetches workflows from KeeperHub API and dispatches executions
  # ===========================================================================
  sc-event-worker:
    build:
      context: ./keeperhub-events/sc-event-worker
      dockerfile: Dockerfile
    container_name: keeperhub-event-worker
    hostname: sc-event-worker
    restart: unless-stopped
    ports:
      - "3010:3010"
    environment:
      WATCH_MODE: "true"
      PORT: 3010
      TIMEOUT_BETWEEN_SYNC: 30000
      KEEPERHUB_API_URL: http://keeperhub:3000
      KEEPERHUB_API_KEY: ${KEEPERHUB_API_KEY:-local-events-key-for-dev}
      JWT_TOKEN_USERNAME: ${JWT_TOKEN_USERNAME:-}
      JWT_TOKEN_PASSWORD: ${JWT_TOKEN_PASSWORD:-}
      NODE_ENV: development
    depends_on:
      app-dev:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010/data"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - dev
      - minikube

  # ===========================================================================
  # Event Tracker (keeperhub-events submodule)
  # Monitors blockchain events and synchronizes with the system
  # ===========================================================================
  sc-event-tracker:
    build:
      context: ./keeperhub-events/sc-event-tracker
      dockerfile: Dockerfile
    container_name: keeperhub-event-tracker
    restart: unless-stopped
    environment:
      WATCH_MODE: "true"
      KEEPERHUB_API_URL: http://keeperhub:3000
      WORKER_URL: http://sc-event-worker:3010
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_TOKEN_USERNAME: ${JWT_TOKEN_USERNAME:-}
      JWT_TOKEN_PASSWORD: ${JWT_TOKEN_PASSWORD:-}
      KEEPERHUB_API_KEY: ${KEEPERHUB_API_KEY:-local-events-key-for-dev}
      ETHERSCAN_API_KEY: ${ETHERSCAN_API_KEY:-}
      NODE_ENV: development
    depends_on:
      redis:
        condition: service_started
      sc-event-worker:
        condition: service_healthy
    profiles:
      - dev
      - minikube

  # ===========================================================================
  # Database Migrator (one-shot)
  # ===========================================================================
  migrator:
    build:
      context: .
      dockerfile: Dockerfile
      target: migrator
    image: keeperhub-migrator:latest
    container_name: keeperhub-migrator
    environment:
      <<: *env_db_connection
    depends_on:
      db:
        condition: service_healthy
    command: pnpm db:migrate
    profiles:
      - migrator

  # ===========================================================================
  # Workflow Profiling Tools
  # ===========================================================================

  # JS Sandbox for WASM fuel calibration
  # Uses Spidermonkey compiled to WASM for deterministic instruction counting
  # See: scripts/runtime/workflow_runtime_analysis/calibrate-wasm-fuel.ts
  js-sandbox:
    image: forbeslindesay/secure-js-sandbox:latest
    container_name: keeperhub-js-sandbox
    hostname: js-sandbox
    ports:
      - "3001:3000"  # External 3001 to avoid conflict with app on 3000
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    profiles:
      - profile-workflows

  # ===========================================================================
  # Redis (for caching)
  # ===========================================================================
  redis:
    image: valkey/valkey:latest
    container_name: keeperhub-redis
    hostname: redis
    ports:
      - 6379:6379
    restart: unless-stopped
    profiles:
      - dev
      - minikube

# =============================================================================
# Volumes
# =============================================================================
volumes:
  keeperhub_db_data:
    name: keeperhub_db_data
  keeperhub_node_modules:
    name: keeperhub_node_modules
  keeperhub_localstack_data:
    name: keeperhub_localstack_data

# =============================================================================
# Networks
# =============================================================================
networks:
  default:
    name: keeperhub-network
    external: true
