# Job Spawner Deployment - Staging
# Polls SQS for scheduled workflow triggers and creates K8s Jobs to execute them
#
# This is a long-running deployment that:
# 1. Receives messages from SQS (sent by schedule-dispatcher)
# 2. Creates workflow execution records in the database
# 3. Spawns K8s Jobs to run the actual workflows

replicaCount: 1

service:
  enabled: false  # No service needed - this is a background worker

ingress:
  enabled: false

image:
  repository: ${ECR_REGISTRY}/keeperhub-staging
  tag: scheduler-${IMAGE_TAG}
  pullPolicy: Always

deployment:
  enabled: true

# Use the same service account as main app (has K8s job creation permissions)
serviceAccount:
  create: false
  name: keeperhub-staging

podAnnotations:
  reloader.stakater.com/auto: "true"

resources:
  limits:
    memory: 512Mi
    cpu: 500m
  requests:
    cpu: 50m
    memory: 128Mi

command: ["/bin/sh"]
args:
  - "-c"
  - |
    echo "$(date) - [JobSpawner] Starting..."
    tsx scripts/job-spawner.ts

env:
  # Database connection
  DATABASE_URL:
    type: parameterStore
    name: db-url
    parameter_name: /eks/maker-staging/keeperhub/db-url
  # AWS/SQS configuration (no endpoint for real AWS)
  AWS_REGION:
    type: kv
    value: "us-east-2"
  SQS_QUEUE_URL:
    type: kv
    value: "https://sqs.us-east-2.amazonaws.com/068992353948/keeperhub-workflow-queue-staging"
  # K8s Job configuration
  RUNNER_IMAGE:
    type: kv
    value: "${ECR_REGISTRY}/keeperhub-staging:workflow-runner-${IMAGE_TAG}"
  K8S_NAMESPACE:
    type: kv
    value: "keeperhub"
  JOB_TTL_SECONDS:
    type: kv
    value: "3600"
  JOB_ACTIVE_DEADLINE:
    type: kv
    value: "300"
  # For workflow runner jobs - passed to created K8s Jobs
  INTEGRATION_ENCRYPTION_KEY:
    type: parameterStore
    name: integration-encryption-key
    parameter_name: /eks/maker-staging/keeperhub/integration-encryption-key

externalSecrets:
  clusterSecretStoreName: maker-staging

# Exec probe to check if the node process is running
livenessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - "pgrep -f 'job-spawner' || exit 1"
  initialDelaySeconds: 30
  periodSeconds: 30
  failureThreshold: 3
readinessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - "pgrep -f 'job-spawner' || exit 1"
  initialDelaySeconds: 10
  periodSeconds: 10
