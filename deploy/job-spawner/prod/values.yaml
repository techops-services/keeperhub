# Job Spawner Deployment - Production
# Polls SQS for scheduled workflow triggers and creates K8s Jobs to execute them
#
# NOTE: Production deployment not yet enabled - this is a placeholder
# Update SQS_QUEUE_URL and parameter paths when ready

replicaCount: 1

service:
  enabled: false

ingress:
  enabled: false

image:
  repository: ${ECR_REGISTRY}/keeperhub-prod
  tag: scheduler-${IMAGE_TAG}
  pullPolicy: Always

deployment:
  enabled: true

serviceAccount:
  create: false
  name: keeperhub-prod

podAnnotations:
  reloader.stakater.com/auto: "true"

resources:
  limits:
    memory: 512Mi
    cpu: 500m
  requests:
    cpu: 50m
    memory: 128Mi

command: ["/bin/sh"]
args:
  - "-c"
  - |
    echo "$(date) - [JobSpawner] Starting..."
    tsx scripts/job-spawner.ts

env:
  DATABASE_URL:
    type: parameterStore
    name: db-url
    parameter_name: /eks/maker-prod/keeperhub/db-url
  AWS_REGION:
    type: kv
    value: "us-east-1"
  # TODO: Create production SQS queue
  SQS_QUEUE_URL:
    type: kv
    value: "https://sqs.us-east-1.amazonaws.com/068992353948/keeperhub-workflow-queue-prod"
  RUNNER_IMAGE:
    type: kv
    value: "${ECR_REGISTRY}/keeperhub-prod:workflow-runner-${IMAGE_TAG}"
  K8S_NAMESPACE:
    type: kv
    value: "keeperhub"
  JOB_TTL_SECONDS:
    type: kv
    value: "3600"
  JOB_ACTIVE_DEADLINE:
    type: kv
    value: "300"
  INTEGRATION_ENCRYPTION_KEY:
    type: parameterStore
    name: integration-encryption-key
    parameter_name: /eks/maker-prod/keeperhub/integration-encryption-key

externalSecrets:
  clusterSecretStoreName: maker-prod

livenessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - "pgrep -f 'job-spawner' || exit 1"
  initialDelaySeconds: 30
  periodSeconds: 30
  failureThreshold: 3
readinessProbe:
  exec:
    command:
      - /bin/sh
      - -c
      - "pgrep -f 'job-spawner' || exit 1"
  initialDelaySeconds: 10
  periodSeconds: 10
