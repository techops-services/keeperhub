# Helm values template for PR environments
# Variables to be replaced: ${PR_NUMBER}, ${ECR_REGISTRY}, ${IMAGE_TAG}, ${DB_PASSWORD}

shared_env: &shared_env
  DATABASE_URL:
    type: kv
    value: "postgresql://keeperhub:${DB_PASSWORD}@keeperhub-pr-${PR_NUMBER}-db-rw.pr-${PR_NUMBER}.svc.cluster.local:5432/keeperhub"
  WORKFLOW_POSTGRES_URL:
    type: kv
    value: "postgresql://keeperhub:${DB_PASSWORD}@keeperhub-pr-${PR_NUMBER}-db-rw.pr-${PR_NUMBER}.svc.cluster.local:5432/keeperhub"
  CHAIN_RPC_CONFIG:
    type: parameterStore
    name: chain-rpc-config
    parameter_name: /eks/maker-staging/keeperhub/chain-rpc-config

replicaCount: 1

service:
  enabled: true
  name: keeperhub-pr-${PR_NUMBER}
  port: 3000
  type: ClusterIP
  containerPort: 3000
  tls:
    enabled: true
    issuerName: cloudflare

ingress:
  enabled: true
  hosts:
    - app-pr-${PR_NUMBER}.keeperhub.com
  annotations:
    external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.tls.options: traefik-cloudflare-origin-pull@kubernetescrd

httpWwwRedirect:
  enabled: false
httpBasicAuth:
  enabled: false

image:
  repository: ${ECR_REGISTRY}/keeperhub-staging
  tag: app-${IMAGE_TAG}
  pullPolicy: Always

deployment:
  enabled: true
  initContainers:
    - name: db-migration
      image: "${ECR_REGISTRY}/keeperhub-staging:migrator-${IMAGE_TAG}"
      command:
        - /bin/sh
        - -c
      args:
        - |
          echo "Setting up workflow postgres tables..."
          export WORKFLOW_POSTGRES_URL=$(node -e "
            const u = process.env.WORKFLOW_POSTGRES_URL || process.env.DATABASE_URL || '';
            try { new URL(u); console.log(u); } catch {
              const s = u.indexOf('://') + 3;
              const a = u.lastIndexOf('@');
              const c = u.indexOf(':', s);
              if (s > 3 && a > c && c > s) {
                console.log(u.slice(0, s) + encodeURIComponent(u.slice(s, c)) + ':' + encodeURIComponent(u.slice(c + 1, a)) + u.slice(a));
              } else { console.log(u); }
            }
          ")
          pnpm exec workflow-postgres-setup
          echo "Running database migrations..."
          pnpm db:push
          echo "Seeding chains..."
          pnpm db:seed
          echo "Migrations and seeding completed successfully"
      env: *shared_env

serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: ${SERVICE_ACCOUNT_ROLE_ARN}
  name: keeperhub-pr-${PR_NUMBER}
  rules:
    - apiGroups: ["batch"]
      resources: ["jobs"]
      verbs: ["create", "get", "list", "watch", "delete"]
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list", "watch"]
    - apiGroups: [""]
      resources: ["pods/log"]
      verbs: ["get"]

podAnnotations:
  reloader.stakater.com/auto: "true"

serviceMonitors:
  enabled: false

resources:
  limits:
    memory: 1Gi
  requests:
    cpu: 1m
    memory: 256Mi

env:
  <<: *shared_env
  LOG_LEVEL:
    type: kv
    value: "debug"
  METRICS_COLLECTOR:
    type: kv
    value: "prometheus"
  NODE_OPTIONS:
    type: kv
    value: "--enable-source-maps --trace-warnings"
  HOSTNAME:
    type: kv
    value: "0.0.0.0"
  PARA_ENVIRONMENT:
    type: kv
    value: "beta"
  WORKFLOW_TARGET_WORLD:
    type: kv
    value: "@workflow/world-postgres"
  NEXT_PUBLIC_API_URL:
    type: kv
    value: "http://localhost:3000"
  BETTER_AUTH_URL:
    type: kv
    value: "https://app-pr-${PR_NUMBER}.keeperhub.com"
  # Auth and social providers (GitHub, Google)
  NEXT_PUBLIC_AUTH_PROVIDERS:
    type: kv
    value: "email,github,google"
  GITHUB_CLIENT_ID:
    type: parameterStore
    name: github-client-id
    parameter_name: /eks/maker-staging/keeperhub/github-client-id
  GITHUB_CLIENT_SECRET:
    type: parameterStore
    name: github-client-secret
    parameter_name: /eks/maker-staging/keeperhub/github-client-secret
  NEXT_PUBLIC_GITHUB_CLIENT_ID:
    type: parameterStore
    name: next-public-github-client-id
    parameter_name: /eks/maker-staging/keeperhub/github-client-id
  GOOGLE_CLIENT_ID:
    type: parameterStore
    name: google-client-id
    parameter_name: /eks/maker-staging/keeperhub/google-client-id
  GOOGLE_CLIENT_SECRET:
    type: parameterStore
    name: google-client-secret
    parameter_name: /eks/maker-staging/keeperhub/google-client-secret
  NEXT_PUBLIC_GOOGLE_CLIENT_ID:
    type: parameterStore
    name: next-public-google-client-id
    parameter_name: /eks/maker-staging/keeperhub/google-client-id
  BETTER_AUTH_SECRET:
    type: parameterStore
    name: better-auth-secret
    parameter_name: /eks/maker-staging/keeperhub/better-auth-secret
  OPENAI_API_KEY:
    type: parameterStore
    name: openai-api-key
    parameter_name: /eks/maker-staging/keeperhub/openai-api-key
  AI_MODEL:
    type: kv
    value: "gpt-4o-mini"
  PARA_API_KEY:
    type: parameterStore
    name: para-api-key
    parameter_name: /eks/maker-staging/keeperhub/para-api-key
  WALLET_ENCRYPTION_KEY:
    type: parameterStore
    name: wallet-encryption-key
    parameter_name: /eks/maker-staging/keeperhub/wallet-encryption-key
  INTEGRATION_ENCRYPTION_KEY:
    type: parameterStore
    name: integration-encryption-key
    parameter_name: /eks/maker-staging/keeperhub/integration-encryption-key
  ETHERSCAN_API_KEY:
    type: parameterStore
    name: etherscan-api-key
    parameter_name: /eks/maker-staging/keeper-app/etherscan-api-key
  SENDGRID_API_KEY:
    type: parameterStore
    name: sendgrid-api-key
    parameter_name: /eks/maker-staging/keeper-app/sendgrid-api-key
  FROM_ADDRESS:
    type: kv
    value: "noreply@keeperhub.com"
  SENTRY_DSN:
    type: parameterStore
    name: sentry-dsn
    parameter_name: /eks/maker-staging/keeperhub/sentry-dsn
  NEXT_PUBLIC_SENTRY_DSN:
    type: parameterStore
    name: next-public-sentry-dsn
    parameter_name: /eks/maker-staging/keeperhub/next-public-sentry-dsn
  SENTRY_ORG:
    type: parameterStore
    name: sentry-org
    parameter_name: /eks/maker-staging/keeperhub/sentry-org
  SENTRY_PROJECT:
    type: parameterStore
    name: sentry-project
    parameter_name: /eks/maker-staging/keeperhub/sentry-project
  SENTRY_AUTH_TOKEN:
    type: parameterStore
    name: sentry-auth-token
    parameter_name: /eks/maker-staging/keeperhub/sentry-auth-token
  FEEDBACK_SERVICE_URL:
    type: kv
    value: "http://keeperhub-feedback-common.keeperhub:3001/api/feedback"
  FEEDBACK_API_KEY:
    type: parameterStore
    name: feedback-api-key
    parameter_name: /eks/maker-staging/keeperhub-feedback/feedback-api-key
  MCP_SERVICE_API_KEY:
    type: parameterStore
    name: mcp-service-api-key
    parameter_name: /eks/maker-staging/keeperhub-mcp/keeperhub-api-key
  EVENTS_SERVICE_API_KEY:
    type: parameterStore
    name: events-service-api-key
    parameter_name: /eks/maker-staging/keeperhub-events/keeperhub-api-key
  SCHEDULER_SERVICE_API_KEY:
    type: parameterStore
    name: scheduler-service-api-key
    parameter_name: /eks/maker-staging/keeperhub-scheduler/keeperhub-api-key
  # PR-specific SQS configuration (using LocalStack)
  AWS_REGION:
    type: kv
    value: "us-east-1"
  AWS_ENDPOINT:
    type: kv
    value: "http://localstack.pr-${PR_NUMBER}.svc.cluster.local:4566"
  SQS_QUEUE_URL:
    type: kv
    value: "http://localstack.pr-${PR_NUMBER}.svc.cluster.local:4566/000000000000/keeperhub-workflow-queue"

externalSecrets:
  clusterSecretStoreName: maker-staging

livenessProbe:
  initialDelaySeconds: 15
  periodSeconds: 30
  tcpSocket:
    port: 3000
readinessProbe:
  initialDelaySeconds: 10
  periodSeconds: 30
  tcpSocket:
    port: 3000
